pipeline {
    agent any

    tools {
        maven 'Maven'
    }

    environment {
        SONAR_TOKEN = credentials('SONAR_TOKEN')
        SPRING_PROFILES_ACTIVE = 'docker'
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Akankshya1402/Loan--Management-System-Backend-.git'
            }
        }

        stage('Build & Test') {
            steps {
                bat '''
                mvn clean verify
                '''
            }
        }

        stage('SonarCloud Analysis') {
            steps {
                bat '''
                mvn sonar:sonar ^
                -Dsonar.token=%SONAR_TOKEN% ^
                -Dsonar.host.url=https://sonarcloud.io ^
                -Dsonar.organization=YOUR_ORG_NAME ^
                -Dsonar.projectKey=YOUR_PROJECT_KEY ^
                -Dsonar.coverage.jacoco.xmlReportPaths=**/target/site/jacoco/jacoco.xml ^
                -Dsonar.qualitygate.wait=true
                '''
            }
        }

        stage('Build Docker Images') {
            steps {
                bat '''
                docker-compose build
                '''
            }
        }

        stage('Run Containers') {
            steps {
                bat '''
                docker-compose up -d
                '''
            }
        }
    }

    post {
        success {
            echo '✅ Pipeline completed successfully'
        }
        failure {
            echo '❌ Pipeline failed'
        }
    }
}
